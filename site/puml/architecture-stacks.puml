@startuml architecture-stacks
!theme plain
allowmixing
left to right direction
skinparam shadowing false


title FOMC Agent - AWS Services and Data Flows\n(Current CDK stacks + runtime wiring)

actor "Developer" as dev
actor "Browser User" as user
cloud "BLS LABSTAT\ndownload.bls.gov" as bls
cloud "DataUSA API\napi.datausa.io" as datausa

package "AWS Account (CDK deployment target)" as aws #F8F9FA {

  package "FomcStorageStack" as storage_stack <<CloudFormation Stack>> #E8F5E9 {
    storage "S3 Bucket\n{prefix}-bls-raw" as bls_raw <<AWS::S3::Bucket>>
    storage "S3 Bucket\n{prefix}-datausa-raw" as datausa_raw <<AWS::S3::Bucket>>
    storage "S3 Bucket\n{prefix}-bls-processed" as bls_processed <<AWS::S3::Bucket>>
    storage "S3 Bucket\n{prefix}-datausa-processed" as datausa_processed <<AWS::S3::Bucket>>

    queue "SQS Queue\n{FOMC_ANALYTICS_QUEUE_NAME}" as analytics_queue <<AWS::SQS::Queue>>
    queue "SQS DLQ\n{FOMC_ANALYTICS_DLQ_NAME}" as analytics_dlq <<AWS::SQS::Queue>>
    rectangle "S3 Notification Rule\nOBJECT_CREATED + suffix=.json" as s3_notif <<S3 NotificationConfiguration>>

    analytics_queue -[dashed]-> analytics_dlq : after 3 failed receives
    datausa_raw --> s3_notif
    s3_notif --> analytics_queue : publish S3 event
  }

  package "FomcComputeStack" as compute_stack <<CloudFormation Stack>> #E3F2FD {
    component "EventBridge Rule\nFetchScheduleRule" as fetch_rule <<AWS::Events::Rule>>
    component "Lambda\nfomc-data-fetcher" as data_fetcher <<AWS::Lambda::Function>>
    component "CloudWatch Log Group\n/aws/lambda/fomc-data-fetcher" as fetcher_logs <<AWS::Logs::LogGroup>>
    component "IAM Role\n(data fetcher)" as fetcher_role <<AWS::IAM::Role>>

    fetch_rule --> data_fetcher : invoke rate(hours=FOMC_FETCH_INTERVAL_HOURS)
    fetcher_role -[dotted]-> data_fetcher : grant_read_write(raw buckets)
    data_fetcher --> fetcher_logs : function logs
  }

  package "FomcMessagingStack" as messaging_stack <<CloudFormation Stack>> #FFF3E0 {
    component "Lambda\nfomc-analytics-processor" as analytics_lambda <<AWS::Lambda::Function>>
    component "Lambda Event Source Mapping\nSQS -> Lambda (batch=1)" as sqs_mapping <<AWS::Lambda::EventSourceMapping>>
    component "CloudWatch Log Group\n/aws/lambda/fomc-analytics-processor" as analytics_logs <<AWS::Logs::LogGroup>>
    component "IAM Role\n(analytics processor)" as analytics_role <<AWS::IAM::Role>>

    analytics_queue --> sqs_mapping : message delivery
    sqs_mapping --> analytics_lambda : invoke
    analytics_role -[dotted]-> analytics_lambda : grant_read(raw buckets + queue access)
    analytics_lambda --> analytics_logs : function logs
  }

  package "FomcSiteStack" as site_stack <<CloudFormation Stack>> #F3E5F5 {
    storage "S3 Bucket\n{prefix}-site" as site_bucket <<AWS::S3::Bucket>>
    component "CloudFront Distribution" as cf_dist <<AWS::CloudFront::Distribution>>
    component "BucketDeployment\n(site/* upload + invalidation)" as site_deploy <<CDK Construct>>
    component "ACM Certificate\n(optional, custom domains)" as cert <<AWS::CertificateManager::Certificate>>

    cf_dist --> site_bucket : origin read (private bucket)
    site_deploy --> site_bucket : upload static assets
    site_deploy --> cf_dist : invalidate /*
    cert --> cf_dist : TLS cert when aliases configured
  }
}

bls --> data_fetcher : HTTPS GET directory + files

datausa --> data_fetcher : HTTPS GET JSON datasets


data_fetcher --> bls_raw : sync files + _sync_state/*
data_fetcher --> datausa_raw : write *.json + _sync_state/*

analytics_lambda --> bls_raw : read BLS file (BLS_KEY)
analytics_lambda --> datausa_raw : read population.json

user --> cf_dist : HTTPS requests
cf_dist --> user : HTML/JS/CSS/JSON responses

dev --> site_deploy : cdk deploy FomcSiteStack

note bottom of bls_processed
  Provisioned for future transforms.
  Current runtime flow is raw -> analytics.
end note

note bottom of datausa_processed
  Provisioned for future transforms.
  Current runtime flow is raw -> analytics.
end note

@enduml
