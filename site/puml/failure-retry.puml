@startuml failure-retry
!theme cyborg
skinparam backgroundColor #020A20
skinparam defaultFontColor #ffffff
skinparam participantBorderColor #387CF1
skinparam participantBackgroundColor #0a1628
skinparam actorBorderColor #387CF1
skinparam queueBorderColor #f59e0b
skinparam queueBackgroundColor #1a1505
skinparam arrowColor #387CF1
skinparam noteBorderColor #6b7280
skinparam noteBackgroundColor #111d35
skinparam sequenceLifeLineBorderColor #387CF1
skinparam titleFontColor #ffffff

title FOMC Agent â€” Reliability\n(At-least-once processing with SQS)

actor "Producer\n(S3 Notification\nor Upstream Step)" as Producer
queue "SQS Queue\n{FOMC_ANALYTICS_QUEUE_NAME}" as Q
participant "Consumer\n(Lambda / Worker)" as Worker
participant "CloudWatch Logs" as Logs
queue "DLQ\n{FOMC_ANALYTICS_DLQ_NAME}" as DLQ

Producer -> Q : SendMessage(event)
activate Q

Q -> Worker : Invoke (batch_size=1)
activate Worker
Worker -> Logs : log start + payload metadata

alt Success path
  Worker -> Logs : log structured result
  Worker -> Q : DeleteMessage
  note over Q
    Message removed.
    Processing is complete.
  end note
else Failure path (exception or timeout)
  Worker -> Logs : log error + stack trace
  note over Q
    VisibilityTimeout hides the message
    while the consumer is processing.
  end note
  note over Q
    After VisibilityTimeout expires,
    the message becomes visible again
    for retry.
  end note
  Q -> Worker : Retry (up to maxReceiveCount=3)
  activate Worker
  Worker -> Logs : log retry attempt
  deactivate Worker
  alt Still failing after retries
    Q -> DLQ : MoveMessage (redrive policy)
    note over DLQ
      Messages retained for debugging
      and manual replay.
    end note
  end
end

deactivate Worker
deactivate Q

@enduml
